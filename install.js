#!/usr/bin/env bun
// @bun @bun-cjs
(function(exports, require, module, __filename, __dirname) {var w=require("fs"),p=require("path");var te={name:"orchestrate",description:"Primary orchestrator that delegates to specialist agents",mode:"primary",primaryModel:{provider:"synthetic",model:"hf:moonshotai/Kimi-K2.5"},fallbackModel:{provider:"opencode",model:"kimi-k2.5-free"},temperature:0.3,steps:10,color:"primary",subagents:["coder","reviewer","tester","explorer","researcher","implementer","planner","documenter","auditor"]},oe={name:"coder",description:"Specialized in writing, modifying, and refactoring code",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:Qwen/Qwen3-Coder-480B-Instruct"},fallbackModel:{provider:"opencode",model:"big-pickle"},temperature:0.2,steps:8,color:"success"},ne={name:"reviewer",description:"Specialized in code review, security analysis, and quality assessment",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:zai-org/GLM-4.7"},fallbackModel:{provider:"opencode",model:"big-pickle"},temperature:0.1,steps:6,color:"warning"},re={name:"tester",description:"Specialized in writing, running, and analyzing tests",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:Qwen/Qwen3-Coder-480B-Instruct"},fallbackModel:{provider:"opencode",model:"big-pickle"},temperature:0.2,steps:6,color:"info"},se={name:"explorer",description:"Fast, read-only codebase exploration and analysis",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:MiniMaxAI/MiniMax-M2.5"},fallbackModel:{provider:"opencode",model:"minimax-m2.5-free"},temperature:0.3,steps:5,color:"success"},ie={name:"researcher",description:"Fast, parallel spammable researcher for information gathering",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:MiniMaxAI/MiniMax-M2.5"},fallbackModel:{provider:"opencode",model:"minimax-m2.5-free"},temperature:0.4,steps:4,color:"success"},ae={name:"implementer",description:"Implementation specialist with reliable tool calls",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:Qwen/Qwen3-Coder-480B-Instruct"},fallbackModel:{provider:"opencode",model:"big-pickle"},temperature:0.2,steps:6,color:"success"},ce={name:"planner",description:"Architecture design and technical planning specialist",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:deepseek-ai/DeepSeek-V3.2"},fallbackModel:{provider:"opencode",model:"gpt-5-nano"},temperature:0.5,steps:8,color:"primary"},le={name:"documenter",description:"Documentation and comments specialist",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:moonshotai/Kimi-K2.5"},fallbackModel:{provider:"opencode",model:"kimi-k2.5-free"},temperature:0.4,steps:5,color:"info"},de={name:"auditor",description:"Thorough security audit and vulnerability specialist",mode:"subagent",primaryModel:{provider:"synthetic",model:"hf:zai-org/GLM-4.7"},fallbackModel:{provider:"opencode",model:"big-pickle"},temperature:0.1,steps:6,color:"danger"},P=[te,oe,ne,re,se,ie,ae,ce,le,de];var pe=["code-analysis","security-scanning","project-intelligence","workflow-automation","external-integration","development-utilities"],me=["feature-implementation","bug-fix","refactoring","api-endpoint","code-review","security-audit","test-coverage","performance-optimization","add-documentation","update-readme","create-api-docs","dependency-update","code-cleanup","migration-assistance"],ue={name:"full",description:"Full framework with everything - jack of all trades",agents:["orchestrate","coder","reviewer","tester","explorer","researcher","implementer","planner","documenter","auditor"],tools:pe,commands:me},ge={name:"stock",description:"Recommended for most users - balanced feature set",agents:["orchestrate","coder","reviewer","tester","explorer","planner","documenter"],tools:["code-analysis","security-scanning","project-intelligence","workflow-automation"],commands:["feature-implementation","bug-fix","code-review","security-audit","test-coverage","add-documentation","dependency-update"]},fe={name:"micro",description:"Speed-optimized for fast execution",agents:["orchestrate","coder","explorer","researcher"],tools:["code-analysis","project-intelligence","workflow-automation"],commands:["feature-implementation","bug-fix","code-review","test-coverage","add-documentation"]},he={name:"mini",description:"Balanced default for everyday use",agents:["orchestrate","coder","reviewer","tester","explorer"],tools:["code-analysis","security-scanning","project-intelligence"],commands:["feature-implementation","bug-fix","code-review","security-audit","test-coverage","add-documentation","dependency-update"]},ye={name:"nano",description:"Lightweight starter with core functionality",agents:["orchestrate","coder","explorer"],tools:["code-analysis","project-intelligence"],commands:["feature-implementation","bug-fix","code-review","add-documentation"]},Me={name:"pico",description:"Barebones for advanced users who build custom systems",agents:["orchestrate","coder"],tools:[],commands:["feature-implementation","bug-fix"]},g=[ue,ge,fe,he,ye,Me];function k(e){return`{
  "$schema": "https://opencode.ai/config.json",
  "default_agent": "orchestrate",
  "subagents": {
    "*": false
  },
  "agent": {
    ${["build","plan","explore","general"].map((o)=>`"${o}": { "disable": true }`).join(`,
    `)},
    ${e.map((o)=>`"${o}": { "mode": "subagent" }`).join(`,
    `)}
  }
}
`}var f=require("fs"),u=globalThis.Bun;function m(){return process.env.HOME??process.env.USERPROFILE??process.env.HOMEDIR??"/home/user"}async function E(){try{return await u.$`which opencode`.quiet(),!0}catch{return!1}}async function O(){console.log("Installing OpenCode...");try{await u.$`bun install -g opencode`,console.log("OpenCode installed successfully")}catch(e){console.error("Failed to install OpenCode:",e),process.exit(1)}}async function N(){try{return await u.$`which bun`.quiet(),!0}catch{return!1}}async function $(){console.log("Installing Bun...");try{await u.$`curl -fsSL https://bun.sh/install | bash`,console.log("Bun installed successfully. Please restart your shell and run install script again"),process.exit(0)}catch(e){console.error("Failed to install Bun:",e),process.exit(1)}}function I(){if(process.platform==="win32")console.warn("Windows detected. This framework requires macOS/Linux"),console.warn("Please use WSL2 on Windows to install this framework"),process.exit(1)}function _(){if(process.env.SYNTHETIC_API_KEY)return!0;let o=`${m()}/.local/share/opencode/auth.json`;try{let t=f.readFileSync(o,"utf-8").trim();if(t){if(JSON.parse(t).synthetic?.key?.trim())return!0}}catch(t){console.warn("No valid auth.json found for synthetic API key detection:",t)}let n=`${m()}/.secrets/synthetic-api-key`;try{return f.readFileSync(n,"utf-8").trim().length>0}catch{return!1}}function D(){let e=`${m()}/.local/share/opencode/auth.json`;try{let o=f.readFileSync(e,"utf-8").trim();if(!o)return!1;return JSON.parse(o),!0}catch{return!1}}var d=require("fs"),c=require("path"),R=globalThis.Bun;async function h(e){try{await R.$`mkdir -p ${e}`.quiet()}catch(o){console.warn(`Failed to create directory ${e}: ${o.message}`)}}function A(e){try{d.mkdirSync(e,{recursive:!0})}catch(o){console.warn(`Failed to create directory ${e}: ${o.message}`)}}async function T(e){await h(`${e}/agents`),await h(`${e}/plugins`),await h(`${e}/commands`),await h(`${e}/meta`)}function L(e,o,n){let t=c.join(n,"plugins");A(t),e.forEach((s)=>{let r=c.join(o,`plugins/${s}.ts`);try{let i=d.readFileSync(r,"utf-8"),l=c.join(t,`${s}.ts`);d.writeFileSync(l,i),console.log(`Created: ${l}`)}catch(i){console.warn(`Plugin ${s} not found, skipping...`)}})}function B(e,o,n){let t=c.join(n,"commands");A(t),e.forEach((s)=>{let r=c.join(o,`templates/commands/${s}.md`);try{let i=d.readFileSync(r,"utf-8"),l=c.join(t,`${s}.md`);d.writeFileSync(l,i),console.log(`Created: ${l}`)}catch(i){console.warn(`Command ${s} not found, skipping...`)}})}function F(e,o){let n=c.join(e,"meta"),t=c.join(o,"meta");A(t),["agent-template.md","command-template.md","tool-template.ts"].forEach((r)=>{let i=c.join(n,r),l=d.readFileSync(i,"utf-8"),M=c.join(t,r);d.writeFileSync(M,l),console.log(`Created: ${M}`)})}function j(e,o,n,t,s){let r=`${e}/${o}`;if(s.includes(r))return r;let i=`${n}/${t}`;if(s.includes(i))return i;return console.warn(`Neither ${r} nor ${i} available`),i}function H(e,o){if(o)return o;console.log(`
Select preset:`),e.forEach((r,i)=>{console.log(`  ${i+1}) ${r.name.padEnd(10)} - ${r.description}`)});let n=prompt("Enter preset number (1-6):"),t=Number.parseInt(n||"1",10)-1;if(Number.isNaN(t)||t<0||t>=e.length)return console.log("Invalid selection - using 'stock' preset..."),"stock";return e[t]?.name||"stock"}var Y=require("fs"),G=require("path");var be=["npm install","npm run build","npm run dev","npm run serve","npm test","npm run test","npm run lint","npm run typecheck"],Ae=["yarn install","yarn build","yarn test","yarn lint"],Se=["pnpm install","pnpm build","pnpm test"],ve=["bun install","bun run build","bun run dev","bun test","bun run test"],we=["deno install","deno task build","deno task test","deno task fmt","deno lint"],Ce=["python -m build","pip install","pytest","python -m pytest","ruff check","python -m unittest"],xe=["cargo build","cargo test","cargo run","cargo clippy","rustc"],Pe=["go build","go test","go run","golangci-lint"],ke=["mvn compile","mvn package","mvn test","ant build","ant test","gradle build","gradle test","./gradlew build","./gradlew test"],Ee=["dotnet build","dotnet test","dotnet run"],Oe=["cmake --build build"],Ne=["make","make build","make test"],$e=["xmake build","xmake test"],Ie=["swift build","swift test"],_e=["gem install","bundle install","bundle exec rspec"],De=["composer install","phpunit"],U=[...be,...Ae,...Se,...ve,...we,...Ce,...xe,...Pe,...ke,...Ee,...Oe,...Ne,...$e,...Ie,..._e,...De],Re=["npm publish"],Te=["yarn publish"],Le=["pnpm publish"],Be=["cargo publish"],Fe=["git commit","git push","git merge","git rebase","git cherry-pick","git tag","git add"],je=["gh pr merge","gh repo create"],He=["docker push"],Ue=["kubectl","helm","terraform apply","serverless deploy"],Ke=["sed","awk","perl -pi"],K=[...Fe,...je,...Re,...Te,...Le,...Be,...He,...Ue,...Ke];var z="    ";function W(e,o,n){return e.map((t)=>`${o}"${t}": "${n}"`).join(`
`)}function J(e,o,n){let t=G.join(n,`templates/agents/${e.name}.md`),s=Y.readFileSync(t,"utf-8"),r=W(U,z,"allow"),i=W(K,z,"deny");return s.replace(/{{description}}/g,e.description).replace(/{{mode}}/g,e.mode).replace(/{{model}}/g,o).replace(/{{temperature}}/g,e.temperature.toString()).replace(/{{steps}}/g,e.steps.toString()).replace(/{{color}}/g,e.color??"success").replace(/^[ \t]*{{bash_denylist}}[ \t]*$/gm,i).replace(/^[ \t]*{{bash_allowlist}}[ \t]*$/gm,r)}async function q(){try{return(await(await fetch("https://api.github.com/repos/xsyetopz/octoagents/releases/latest")).json()).tag_name??void 0}catch(n){console.warn("Failed to check for updates:",n.message);return}}var S=globalThis.Bun;async function Q(e){let o=new Date().toISOString().replace(/[:.]/g,"-"),n=`${e}.backup-${o}`;try{await S.$`test -d ${e}`.quiet(),await S.$`mv ${e} ${n}`,console.log(`Backed up existing install to ${n}`)}catch{console.log("No existing install directory found, skipping backup...")}}function v(e,o){return`${e}/${o}`}var V=globalThis.Bun;async function X(){try{let{stdout:e}=await V.$`opencode models`,o=[],n=e.toString().split(`
`);for(let t of n){let s=t.trim();if(!s||s.startsWith("krystian@"))continue;let r=s.split("/");if(r.length>=2&&r[0])o.push({provider:r[0],model:r.slice(1).join("/")})}return o}catch(e){return console.warn("Failed to get available models:",e),[]}}var y=p.join(process.cwd()),ze=process.argv.includes("--update"),We=process.argv.find((e)=>g.some((o)=>o.name===e));function Ye(e){console.log(`
Select install location:`),console.log("  1) Global (~/.config/opencode)"),console.log("  2) Project (./.opencode)"),console.log("  3) Custom path");let o=prompt("Enter location number (1-3):"),n=Number.parseInt(o||"1",10)-1;if(Number.isNaN(n)||n<0||n>2)return console.log("Invalid selection - using global install location..."),e;switch(n){case 0:return e;case 1:return p.join(process.cwd(),".opencode");case 2:break;default:return e}let t=prompt("Enter custom install path:")?.trim();if(!t)return console.log("Invalid custom path - using global install location..."),e;return p.isAbsolute(t)?t:p.join(process.cwd(),t)}async function Ge(){if(console.log(`OctoAgents Framework Installer
`),I(),!await N())await $();if(!await E())await O();if(ze){console.log("Checking for updates...");let a=await q();if(a)console.log(`Latest version: ${a}`),console.log("Current version: 1.0.0")}let e=_(),o=D();console.log(e?`
\u2713 Synthetic API key detected`:`
\u2717 No Synthetic API key - using OpenCode Zen models...`),console.log(o?"\u2713 OpenCode auth.json detected":"\u2717 No OpenCode auth.json detected");let n=H(g,We),t=g.find((a)=>a.name===n);if(!t)console.error("Invalid preset selection"),process.exit(1);console.log(`
Installing '${n}' preset...`);let s=p.join(m(),".config/opencode"),r=Ye(s);if(console.log(`
Install location: ${r}`),await Q(r),await T(r),t.commands.length>0)B(t.commands,y,r);F(y,r);let i=k(t.agents),l=v(r,"opencode.jsonc");w.writeFileSync(l,i),console.log(`Created: ${l}`);let b=(await X()).map((a)=>`${a.provider}/${a.model}`);if(b.length>0)console.log(`Found ${b.length} available models`);else console.log("No models detected, will use default assignments");let C=P.filter((a)=>t.agents.includes(a.name));for(let a of C){let Z=j(a.primaryModel.provider,a.primaryModel.model,a.fallbackModel.provider,a.fallbackModel.model,b),ee=J(a,Z,y),x=v(r,`agents/${a.name}.md`);w.writeFileSync(x,ee),console.log(`Created: ${x}`)}if(t.tools.length>0)L(t.tools,y,r);console.log(`
\u2713 Installation complete!`),console.log(`
Preset: ${n}`),console.log(`Agents: ${C.map((a)=>a.name).join(", ")}`),console.log(`Tools: ${t.tools.length}`),console.log(`Commands: ${t.commands.length}`),console.log(`
Next steps:`),console.log("  1. Restart OpenCode to load the new agents"),console.log("  2. Use 'opencode agents list' to verify installation"),console.log("  3. Select 'orchestrate' agent to use the framework"),console.log(`
To update the framework, run: bun install --update`),console.log("To change preset, run: bun install [preset-name]")}Ge().catch((e)=>{console.error("Installation failed:",e),process.exit(1)});})
