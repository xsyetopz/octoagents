#!/bin/bash

set -e

BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE=$1
URL=$2

echo "Running pre-push checks..."

if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
    echo "⚠ You are about to push to $BRANCH branch!"
    echo "This is typically the production branch."
    read -p "Are you sure you want to continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Push cancelled."
        exit 1
    fi
fi

if [ -f "package.json" ] && grep -q '"test"' package.json; then
    echo "Running tests before push..."
    if command -v bun &> /dev/null; then
        bun test 2>/dev/null || npm test
    elif command -v npm &> /dev/null; then
        npm test
    fi

    if [ $? -ne 0 ]; then
        echo "✗ Tests failed. Please fix tests before pushing."
        exit 1
    fi
fi

echo "✓ Pre-push checks passed!"
exit 0
